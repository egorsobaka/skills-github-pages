### Деплой Node.js-приложения в **Docker** и **Kubernetes**

Деплой Node.js-приложения в Docker и Kubernetes — это один из наиболее популярных способов развертывания приложений в современных инфраструктурах. Я расскажу, как это можно сделать, пошагово.

---

### 1. **Деплой в Docker**

#### 1.1 Создание Docker-образа для Node.js-приложения

Для того чтобы развернуть Node.js-приложение в Docker, нужно создать **Dockerfile** — описание для создания Docker-образа.

##### Шаги:

1. Создайте файл `Dockerfile` в корневой папке вашего проекта.

2. Напишите следующее содержание в `Dockerfile`:

```Dockerfile
# Используем официальный образ Node.js
FROM node:16

# Устанавливаем рабочую директорию в контейнере
WORKDIR /app

# Копируем package.json и package-lock.json (или yarn.lock) для установки зависимостей
COPY package*.json ./

# Устанавливаем зависимости
RUN npm install

# Копируем все остальные файлы приложения в контейнер
COPY . .

# Указываем порт, который будет использоваться внутри контейнера
EXPOSE 3000

# Запуск приложения
CMD ["npm", "start"]
```

**Пояснение**:
- `FROM node:16` — образ с Node.js.
- `WORKDIR /app` — рабочая директория внутри контейнера.
- `COPY package*.json ./` — копирование файлов зависимостей для их установки.
- `RUN npm install` — установка зависимостей.
- `COPY . .` — копирование всех остальных файлов проекта в контейнер.
- `EXPOSE 3000` — указание порта, на котором приложение будет работать внутри контейнера (по умолчанию Node.js работает на порту 3000).
- `CMD ["npm", "start"]` — запуск приложения через команду `npm start`.

#### 1.2 Сборка Docker-образа

После того как Dockerfile создан, можно собрать Docker-образ с помощью команды:

```bash
docker build -t your-app-name .
```

Эта команда создаст образ вашего приложения с именем `your-app-name`.

#### 1.3 Запуск контейнера

После того как образ собран, можно запустить контейнер с вашим Node.js-приложением:

```bash
docker run -p 3000:3000 your-app-name
```

Эта команда запустит контейнер, сопоставив порт 3000 на вашем хосте с портом 3000 внутри контейнера, где работает ваше Node.js-приложение.

---

### 2. **Деплой в Kubernetes**

Kubernetes — это система оркестрации контейнеров, которая управляет масштабированием, развертыванием и обслуживанием приложений. Деплой Node.js-приложения в Kubernetes требует нескольких шагов:

#### 2.1 Создание Docker-образа

Перед тем как развернуть приложение в Kubernetes, вам нужно собрать Docker-образ, как показано выше, и загрузить его в Docker Registry (например, Docker Hub, Google Container Registry, AWS ECR и т.д.).

Чтобы загрузить образ в Docker Hub, выполните команду:

```bash
docker tag your-app-name your-dockerhub-username/your-app-name:latest
docker push your-dockerhub-username/your-app-name:latest
```

#### 2.2 Подготовка манифеста Kubernetes (Deployment)

Теперь создадим файл манифеста Kubernetes для деплоя приложения. Например, `deployment.yaml`.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nodejs-app
spec:
  replicas: 3  # Количество реплик (экземпляров)
  selector:
    matchLabels:
      app: nodejs-app
  template:
    metadata:
      labels:
        app: nodejs-app
    spec:
      containers:
      - name: nodejs-app
        image: your-dockerhub-username/your-app-name:latest  # Ссылка на ваш Docker-образ
        ports:
        - containerPort: 3000
---
apiVersion: v1
kind: Service
metadata:
  name: nodejs-app-service
spec:
  selector:
    app: nodejs-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000  # Порт на который мапится контейнер внутри кластера
  type: LoadBalancer  # Для использования с внешним балансировщиком нагрузки
```

**Пояснение**:
- **`Deployment`**: создает и управляет подами (контейнерами) в Kubernetes.
  - `replicas: 3` — количество реплик (экземпляров приложения) для масштабирования.
  - `matchLabels` и `selector` позволяют выбрать нужные поды для обслуживания.
  - `containers` описывает контейнер, который будет запускаться в каждом поде.
- **`Service`**: создает сервис, который будет доступен внутри кластера Kubernetes. Тип `LoadBalancer` создаст внешний балансировщик нагрузки.

#### 2.3 Применение манифеста в Kubernetes

Примените манифест, чтобы развернуть приложение в Kubernetes:

```bash
kubectl apply -f deployment.yaml
```

#### 2.4 Проверка статуса деплоя

Для проверки статуса деплоя можно использовать команду:

```bash
kubectl get pods
```

Это покажет все поды, запущенные в кластере, а также их статусы.

Для просмотра созданных сервисов используйте:

```bash
kubectl get services
```

#### 2.5 Доступ к приложению

Если вы настроили тип сервиса как `LoadBalancer`, то Kubernetes предоставит IP-адрес для доступа к вашему приложению. Вы можете использовать команду:

```bash
kubectl get services
```

чтобы узнать, на каком IP-адресе доступен ваш сервис.

---

### 3. **Дополнительные моменты**

1. **ConfigMaps и Secrets**:
   - Если приложение использует конфигурационные файлы или чувствительные данные (например, пароли), вы можете использовать **ConfigMaps** для хранения конфигураций и **Secrets** для чувствительных данных.

   Пример для конфигурации:
   ```yaml
   apiVersion: v1
   kind: ConfigMap
   metadata:
     name: app-config
   data:
     NODE_ENV: production
   ```

2. **Ingress**:
   - Если вы хотите настроить доступ к приложению через доменное имя, используйте **Ingress**. Ingress позволяет управлять доступом к сервисам через HTTP(S) и маршрутизировать трафик в зависимости от URL.

---

### Заключение

Процесс деплоя Node.js-приложения в **Docker** и **Kubernetes** включает несколько шагов, включая создание Docker-образа, загрузку его в репозиторий, настройку манифеста для Kubernetes и развертывание приложения. Docker позволяет контейнеризировать приложение, а Kubernetes управляет масштабированием и доступом к этому приложению в распределенной среде.
