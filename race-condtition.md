### **Race Condition –≤ Node.js: –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å?**  

**Race Condition (–≥–æ–Ω–∫–∞ –¥–∞–Ω–Ω—ã—Ö)** ‚Äì —ç—Ç–æ —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏–ª–∏ –ø–æ—Ç–æ–∫–æ–≤ **–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ** –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ –æ–±—â–µ–º—É —Ä–µ—Å—É—Ä—Å—É –∏ **–Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ –∏–∑–º–µ–Ω—è—é—Ç –µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**.  

–í **Node.js** —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –¥–∞–∂–µ –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ **–æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω—É—é –º–æ–¥–µ–ª—å**, –Ω–∞–ø—Ä–∏–º–µ—Ä:  
- –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –ë–î, —Ñ–∞–π–ª–∞–º–∏).  
- –ü—Ä–∏ **–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö HTTP-–∑–∞–ø—Ä–æ—Å–∞—Ö** –∫ —Å–µ—Ä–≤–µ—Ä—É.  
- –í **–∫–ª–∞—Å—Ç–µ—Ä–Ω—ã—Ö** –∏–ª–∏ **—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö**.  

---

## **1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**  

–ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç –æ–¥–Ω—É –∏ —Ç—É –∂–µ –∑–∞–ø–∏—Å—å –≤ –ë–î, –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.  

üîπ **–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã (–±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)**  
```javascript
const db = require('./db'); // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î

async function withdraw(userId, amount) {
    const user = await db.getUser(userId); // –ó–∞–ø—Ä–æ—Å —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
    if (user.balance >= amount) {
        await db.updateBalance(userId, user.balance - amount); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
    } else {
        throw new Error('Insufficient funds');
    }
}
```
‚ö† **–ü—Ä–æ–±–ª–µ–º–∞:** –µ—Å–ª–∏ –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ `withdraw()` –ø–æ—Å—Ç—É–ø—è—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –æ–±–∞ –º–æ–≥—É—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å **—Å—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å** –∏ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å **–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –¥–µ–Ω—å–≥–∏**.  

‚úÖ **–†–µ—à–µ–Ω–∏–µ: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**  
–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç **–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å** –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.  

**–ü—Ä–∏–º–µ—Ä —Å PostgreSQL (—á–µ—Ä–µ–∑ `node-postgres`)**
```javascript
const { Pool } = require('pg');
const pool = new Pool();

async function withdraw(userId, amount) {
    const client = await pool.connect();
    try {
        await client.query('BEGIN'); // –ù–∞—á–∞–ª–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        const { rows } = await client.query('SELECT balance FROM users WHERE id = $1 FOR UPDATE', [userId]); // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏
        if (rows[0].balance >= amount) {
            await client.query('UPDATE users SET balance = balance - $1 WHERE id = $2', [amount, userId]);
            await client.query('COMMIT'); // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        } else {
            await client.query('ROLLBACK'); // –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ –æ—à–∏–±–∫–µ
            throw new Error('Insufficient funds');
        }
    } catch (err) {
        await client.query('ROLLBACK'); // –û—Ç–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        throw err;
    } finally {
        client.release();
    }
}
```
‚úÖ **`FOR UPDATE` –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É** –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≥–æ–Ω–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏–π.  

---

## **2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis Lock (–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö)**  

–ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ —Å–µ—Ä–≤–∏—Å–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ–¥–Ω—É –∏ —Ç—É –∂–µ —Å—É—â–Ω–æ—Å—Ç—å, **—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –ë–î —É–∂–µ –Ω–µ –ø–æ–º–æ–≥—É—Ç**. –ù—É–∂–Ω–æ **—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ**.  

### **Redis-based Lock (Redlock)**
**Redlock** ‚Äì —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π **Redis**, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç **–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å** –æ–ø–µ—Ä–∞—Ü–∏–π.  

üìå **–ü—Ä–∏–º–µ—Ä —Å `redlock` –≤ Node.js**  
```javascript
const Redis = require("ioredis");
const Redlock = require("redlock");

const redis = new Redis();
const redlock = new Redlock([redis], { retryCount: 3 });

async function processOrder(orderId) {
    const lock = await redlock.lock(`locks:order:${orderId}`, 1000); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ä–µ—Å—É—Ä—Å –Ω–∞ 1 —Å–µ–∫—É–Ω–¥—É
    try {
        // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è (–±–µ–∑ –≥–æ–Ω–∫–∏ –¥–∞–Ω–Ω—ã—Ö)
        console.log(`Processing order ${orderId}`);
        await new Promise(resolve => setTimeout(resolve, 500)); // –°–∏–º—É–ª—è—Ü–∏—è —Ä–∞–±–æ—Ç—ã
    } finally {
        await lock.unlock(); // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º
    }
}
```
‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä–µ—Å—É—Ä—Å–æ–º –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç.**  
‚ùå **–í–∞–∂–Ω–æ!** Redlock —Ç—Ä–µ–±—É–µ—Ç —Ç–æ—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–π–º–∞—É—Ç–æ–≤, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å deadlock'–æ–≤.  

---

## **3. –û—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (Message Queue)**
–í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—ã—Ç–∞–ª–∏—Å—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –º–æ–∂–Ω–æ **–ø–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å**.  

### **–ü—Ä–∏–º–µ—Ä —Å RabbitMQ (BullMQ)**
```javascript
const { Queue } = require('bullmq');
const myQueue = new Queue('orders');

async function processOrder(orderId) {
    await myQueue.add('process_order', { orderId });
}
```
‚û° **–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –±—É–¥–µ—Ç –±—Ä–∞—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ –æ–¥–Ω–æ–π**, –∏–∑–±–µ–≥–∞—è –≥–æ–Ω–∫–∏ –¥–∞–Ω–Ω—ã—Ö.

---

## **4. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π (Optimistic Locking)**
–ï—Å–ª–∏ –¥–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞ —á–∏—Ç–∞—é—Ç –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –≤ –±–∞–∑–µ **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ**, –ø–æ–º–æ–∂–µ—Ç **–≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π**.  

üìå **–ü—Ä–∏–º–µ—Ä —Å MongoDB –∏ Mongoose**
```javascript
const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
    balance: Number,
}, { versionKey: true }); // –í–∫–ª—é—á–∞–µ–º __v –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–µ—Ä—Å–∏–π

const User = mongoose.model('User', userSchema);

async function updateBalance(userId, amount) {
    const user = await User.findOne({ _id: userId });
    user.balance += amount;
    await user.save(); // –û—à–∏–±–∫–∞, –µ—Å–ª–∏ –¥—Ä—É–≥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–∂–µ –∏–∑–º–µ–Ω–∏–ª–∞ –≤–µ—Ä—Å–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞
}
```
‚úÖ **MongoDB –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç `__v`** –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.  

---

## **5. Atomic –æ–ø–µ—Ä–∞—Ü–∏–∏ (CAS - Compare and Swap)**  
–ö–æ–≥–¥–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**.  

üìå **–ü—Ä–∏–º–µ—Ä —Å Redis (Incr/Decr –≤–º–µ—Å—Ç–æ GET/SET)**
```javascript
const redis = require('ioredis');
const client = new redis();

async function withdraw(userId, amount) {
    const balance = await client.decrby(`user:${userId}:balance`, amount);
    if (balance < 0) {
        await client.incrby(`user:${userId}:balance`, amount); // –û—Ç–∫–∞—Ç
        throw new Error("Insufficient funds");
    }
}
```
‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –±–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ** –±–µ–∑ —É—Å–ª–æ–≤–∏–π –≥–æ–Ω–∫–∏.  

---

## **–í—ã–≤–æ–¥**  

| –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|
| –ì–æ–Ω–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ë–î | **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (`BEGIN ... COMMIT`)** |
| –ì–æ–Ω–∫–∞ –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö | **Redis Lock (Redlock)** |
| –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á (–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏) | **Message Queue (RabbitMQ, BullMQ)** |
| –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ —Ä–∞–∑–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏ | **Optimistic Locking (–≤–µ—Ä—Å–∏–∏ –∑–∞–ø–∏—Å–µ–π)** |
| –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ø–∞–º—è—Ç—å—é (–∫–µ—à, —Å—á–µ—Ç—á–∏–∫–∏) | **Atomic –æ–ø–µ—Ä–∞—Ü–∏–∏ (Redis `INCR/DECR`)** |

üöÄ –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–µ ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ **—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ Redis**.  
üè¢ –ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è ‚Äî **Redlock, Kafka, RabbitMQ**.  

–ß—Ç–æ –≤–∞—Å –±–æ–ª—å—à–µ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç: **—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ Nest.js**, **–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** –∏–ª–∏ **–∫–∞–∫–æ–π-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π**? üòä
